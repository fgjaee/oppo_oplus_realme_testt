name: Release packaging smoke test

env:
  TZ: Asia/Shanghai
  CPU: 'sm8550'
  ANDROID_VERSION: 'android13'
  KERNEL_VERSION: '5.15.167'
  KERNEL_NAME: 'oneplus11_5.15.167'
  KERNELSU_VARIANT: 'SukiSU-Ultra'
  KERNELSU_BRANCH: 'susfs-main'

on:
  workflow_dispatch:
    inputs:
      ksu_type:
        description: 'KernelSU flavour (SukiSU Ultra / KernelSU Next)'
        required: true
        type: choice
        default: 'sukisu'
        options:
          - 'sukisu'
          - 'ksunext'
      hook_method:
        description: 'Preferred hook mode (manual or kprobes)'
        required: true
        type: choice
        default: 'manual'
        options:
          - 'manual'
          - 'kprobes'
      kpm_enable:
        description: 'Enable KPM (patch_linux)'
        required: true
        type: choice
        default: 'true'
        options:
          - 'true'
          - 'false'
      lz4_enable:
        description: 'LZ4/Zstd bundle: 0=none, 1=LZ4+Zstd, 2=LZ4KD, 3=both'
        required: true
        type: choice
        default: '1'
        options:
          - '0'
          - '1'
          - '2'
          - '3'
      bbr_enable:
        description: 'BBR / Brutal congestion control: false=off, true=available, default=set as default'
        required: true
        type: choice
        default: 'false'
        options:
          - 'false'
          - 'true'
          - 'default'
      better_net:
        description: 'Enable extended networking configuration'
        required: true
        type: choice
        default: 'true'
        options:
          - 'true'
          - 'false'
      ssg_rekernel_enable:
        description: 'SSG IO scheduler / ReKernel bundle: 0=off,1=SSG,2=ReKernel,3=both'
        required: true
        type: choice
        default: '1'
        options:
          - '0'
          - '1'
          - '2'
          - '3'
      kernel_suffix:
        description: 'Optional kernel suffix (no leading dash, avoid spaces)'
        required: false
        type: string
        default: ''

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      KSUVER: ${{ steps.ksu_version.outputs.KSUVER }}
    steps:
      - name: Record KernelSU version string
        id: ksu_version
        run: |
          KSU_VERSION="114514"
          echo "KSUVER=$KSU_VERSION" >> $GITHUB_ENV
          echo "ksuver=$KSU_VERSION" >> $GITHUB_OUTPUT

      - name: Stub AnyKernel3 packaging
        run: |
          if [[ ${{ github.event.inputs.ksu_type }} == "sukisu" ]]; then
            KSU_TYPENAME="SukiSU"
          else
            KSU_TYPENAME="KSUNext"
          fi
          if [[ -n "${{ github.event.inputs.kernel_suffix }}" ]]; then
            echo "Created AnyKernel3_${KSU_TYPENAME}_${{ env.KSUVER }}_${{ env.KERNEL_VERSION }}_A13_${{ github.event.inputs.kernel_suffix }}.zip"
          else
            echo "Created AnyKernel3_${KSU_TYPENAME}_${{ env.KSUVER }}_${{ env.KERNEL_VERSION }}_A13_${{ env.KERNEL_NAME }}.zip"
          fi

  release:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      actions: read

    steps:
      - name: Prepare environment metadata
        run: |
          if [[ -n "${{ github.event.inputs.kernel_suffix }}" ]]; then
            FULL_VERSION=${{ format('{0}-{1}', env.KERNEL_VERSION, github.event.inputs.kernel_suffix) }}
            echo "FULL_VERSION=$FULL_VERSION" >> $GITHUB_ENV
            export FULL_VERSION=$FULL_VERSION
          else
            FULL_VERSION=${{ format('{0}-{1}', env.KERNEL_VERSION, env.KERNEL_NAME) }}
            echo "FULL_VERSION=$FULL_VERSION" >> $GITHUB_ENV
            export FULL_VERSION=$FULL_VERSION
          fi
          TIME="$(TZ='Asia/Shanghai' date +'%y%m%d%H%M%S')"
          TIME_FORM="$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')"
          echo "TIME=$TIME" >> $GITHUB_ENV
          echo "TIME_FORM=$TIME_FORM" >> $GITHUB_ENV
          TAG_HEAD="OnePlus-SM8550-A13-build"
          echo "TAG_HEAD=$TAG_HEAD" >> $GITHUB_ENV
          if [[ ${{ github.event.inputs.ksu_type }} == "sukisu" ]]; then
            KSU_BRANCH="SukiSU Ultra"
          else
            KSU_BRANCH="KernelSU Next"
          fi
          echo "KSU_BRANCH=$KSU_BRANCH" >> $GITHUB_ENV
          if [[ "${{ github.event.inputs.lz4_enable }}" == "2" || "${{ github.event.inputs.lz4_enable }}" == "3" ]]; then
            lz4kd_enable="true"
          else
            lz4kd_enable="false"
          fi
          if [[ "${{ github.event.inputs.lz4_enable }}" == "1" || "${{ github.event.inputs.lz4_enable }}" == "3" ]]; then
            lz4_zstd_enable="true"
          else
            lz4_zstd_enable="false"
          fi
          if [[ "${{ github.event.inputs.ssg_rekernel_enable }}" == "1" || "${{ github.event.inputs.ssg_rekernel_enable }}" == "3" ]]; then
            ssg_enable="true"
          else
            ssg_enable="false"
          fi
          if [[ "${{ github.event.inputs.ssg_rekernel_enable }}" == "2" || "${{ github.event.inputs.ssg_rekernel_enable }}" == "3" ]]; then
            rekernel_enable="true"
          else
            rekernel_enable="false"
          fi
          echo "lz4kd_enable=$lz4kd_enable" >> $GITHUB_ENV
          echo "lz4_zstd_enable=$lz4_zstd_enable" >> $GITHUB_ENV
          echo "ssg_enable=$ssg_enable" >> $GITHUB_ENV
          echo "rekernel_enable=$rekernel_enable" >> $GITHUB_ENV

      - name: Create release entry
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "${{ env.TAG_HEAD }}-${{ env.TIME }}"
          name: "${{ env.TAG_HEAD }}-${{ env.FULL_VERSION }}"
          body: |
            ### üì± OnePlus SM8550 Android 13 ${{ env.KSU_BRANCH }} universal kernel | Build information
            - Kernel version: ${{ env.FULL_VERSION }}
            - Build time: ${{ env.TIME_FORM }}
            - Target devices: OnePlus 11 / 12R (Android 13 base, derived from the OnePlus 11 5.15.167 OKI source)
            - Features: ${{ env.KSU_BRANCH }} + SUSFS + VFS + optional KPM
            - Hook mode: ${{ github.event.inputs.hook_method }}
            - KPM enabled: ${{ github.event.inputs.kpm_enable }}
            - LZ4KD enabled: ${{ env.lz4kd_enable }}
            - LZ4/Zstd enabled: ${{ env.lz4_zstd_enable }}
            - Extended networking: ${{ github.event.inputs.better_net }}
            - BBR/Brutal congestion control: ${{ github.event.inputs.bbr_enable }}
            - Samsung SSG IO scheduler: ${{ env.ssg_enable }}
            - ReKernel support: ${{ env.rekernel_enable }}
            - Recommended firmware: OxygenOS / ColorOS based on Android 13
            - SukiSU Ultra manager: [SukiSU-Ultra](https://github.com/SukiSU-Ultra/SukiSU-Ultra/releases)
            - KernelSU Next manager: [KernelSU-Next](https://github.com/KernelSU-Next/KernelSU-Next/releases)
            ### ‚è´Ô∏è Updates
            - Updated ${{ env.KSU_BRANCH }} to the latest available commit (${{ needs.build.outputs.KSUVER }})
            - Placeholder for additional release notes
            ### üìã Installation guide
            1. If your device has a custom recovery (TWRP, etc.), flash the AnyKernel package and reboot.
            2. If your device already has root access, install [HorizonKernelFlasher](https://github.com/libxzr/HorizonKernelFlasher/releases) and flash the AnyKernel package directly.
            3. If you are already on SukiSU Ultra and the manager is up to date, you can flash the AnyKernel package from the manager UI.
            4. When downgrading from a build with the LZ4KD patch, disable zram before flashing a package without LZ4KD.
            #### ‚ö†Ô∏è Flashing kernels involves risk. Always create a full boot image backup with tools such as [KernelFlasher](https://github.com/capntrips/KernelFlasher) before proceeding.
          draft: false
