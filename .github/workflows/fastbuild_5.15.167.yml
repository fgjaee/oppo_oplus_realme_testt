name: 快速构建 5.15.167 (SM8550)

env:
  TZ: Asia/Shanghai

on:
  workflow_dispatch:
    inputs:
      manifest:
        description: '目标一加 SM8550 机型列表(使用+分隔, 默认 oneplus12r)'
        required: false
        type: string
        default: 'oneplus12r'
      kernel_branch:
        description: '指定 OnePlus SM8550 内核分支(留空使用设备默认)'
        required: false
        type: string
        default: ''
      custom_suffix:
        description: '自定义内核后缀(留空自动匹配)'
        required: false
        type: string
        default: ''
      susfs_android_version:
        description: 'SUSFS 补丁 Android 版本(13/14)'
        required: true
        type: choice
        default: '13'
        options:
          - '13'
          - '14'
      enable_kpm:
        description: '是否启用 KPM (patch_linux)' 
        required: true
        type: choice
        default: 'y'
        options:
          - 'y'
          - 'n'
      ksu_type:
        description: 'KernelSU 方案(SukiSU Ultra/KernelSU Next)'
        required: true
        type: choice
        default: 'sukisu'
        options:
          - 'sukisu'
          - 'ksunext'
      hook_mode:
        description: 'SUSFS 钩子模式(manual/syscall/kprobes)'
        required: true
        type: choice
        default: 'manual'
        options:
          - 'manual'
          - 'syscall'
          - 'kprobes'
      feature_flags:
        description: '内核功能开关, 逗号分隔: lz4=,lz4kd=,better_net=,bbr=,ssg=,rekernel=,bbg='
        required: false
        type: string
        default: 'lz4=y,lz4kd=n,better_net=y,bbr=n,ssg=y,rekernel=n,bbg=y'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: 运行 5.15.167 构建脚本
        id: build_kernel
        run: |
          chmod +x local/builder_5.15.167.sh
          cd "$GITHUB_WORKSPACE"

          if [ -n "${{ inputs.manifest }}" ]; then
            export MANIFEST='${{ inputs.manifest }}'
          fi
          if [ -n "${{ inputs.kernel_branch }}" ]; then
            export KERNEL_BRANCH='${{ inputs.kernel_branch }}'
          fi

          if [ -n "${{ inputs.custom_suffix }}" ]; then
            export CUSTOM_SUFFIX='${{ inputs.custom_suffix }}'
          fi
          export SUSFS_ANDROID_VERSION='${{ inputs.susfs_android_version }}'
          export USE_PATCH_LINUX='${{ inputs.enable_kpm }}'
          if [ '${{ inputs.ksu_type }}' = 'sukisu' ]; then
            export KSU_BRANCH='y'
          else
            export KSU_BRANCH='n'
          fi
          case '${{ inputs.hook_mode }}' in
            manual) export APPLY_HOOKS='m' ;;
            syscall) export APPLY_HOOKS='s' ;;
            kprobes) export APPLY_HOOKS='k' ;;
            *) export APPLY_HOOKS='m' ;;
          esac
          FEATURE_FLAGS_RAW='${{ inputs.feature_flags }}'
          FEATURE_FLAGS=$(printf '%s' "$FEATURE_FLAGS_RAW" | tr -d ' \t\n\r')
          get_flag() {
            local key="$1"
            local default="$2"
            local IFS=','
            for pair in $FEATURE_FLAGS; do
              if [ "${pair%%=*}" = "$key" ]; then
                local value="${pair#*=}"
                if [ -n "$value" ]; then
                  printf '%s' "$value"
                  return
                fi
              fi
            done
            printf '%s' "$default"
          }

          export APPLY_LZ4="$(get_flag lz4 y)"
          export APPLY_LZ4KD="$(get_flag lz4kd n)"
          export APPLY_BETTERNET="$(get_flag better_net y)"
          export APPLY_BBR="$(get_flag bbr n)"
          export APPLY_SSG="$(get_flag ssg y)"
          export APPLY_REKERNEL="$(get_flag rekernel n)"
          export APPLY_BBG="$(get_flag bbg y)"

          local/builder_5.15.167.sh

      - name: 列出产物
        run: |
          ls -al kernel_workspace

      - name: 上传 AnyKernel3 ZIP
        uses: actions/upload-artifact@v4
        with:
          name: Kernel_5.15.167_Zips
          path: kernel_workspace/Anykernel3-*.zip
          if-no-files-found: error
