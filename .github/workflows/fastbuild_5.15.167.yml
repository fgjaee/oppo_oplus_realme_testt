name: 快速构建 5.15.167 (SM8550)

env:
  TZ: Asia/Shanghai

on:
  workflow_dispatch:
    inputs:
      manifest:
        description: '目标一加 SM8550 机型列表(使用+分隔, 默认 oneplus12r)'
        required: false
        type: string
        default: 'oneplus12r'
      kernel_branch:
        description: '指定 OnePlus SM8550 内核分支(留空使用设备默认)'
        required: false
        type: string
        default: ''
      custom_suffix:
        description: '自定义内核后缀(留空自动匹配)'
        required: false
        type: string
        default: ''
      susfs_android_version:
        description: 'SUSFS 补丁 Android 版本(13/14)'
        required: true
        type: choice
        default: '13'
        options:
          - '13'
          - '14'
      enable_kpm:
        description: '是否启用 KPM (patch_linux)' 
        required: true
        type: choice
        default: 'y'
        options:
          - 'y'
          - 'n'
      ksu_type:
        description: 'KernelSU 方案(SukiSU Ultra/KernelSU Next)'
        required: true
        type: choice
        default: 'sukisu'
        options:
          - 'sukisu'
          - 'ksunext'
      hook_mode:
        description: 'SUSFS 钩子模式(manual/syscall/kprobes)'
        required: true
        type: choice
        default: 'manual'
        options:
          - 'manual'
          - 'syscall'
          - 'kprobes'
      feature_flags:
        description: '内核功能开关, 逗号分隔: lz4=,lz4kd=,better_net=,bbr=,ssg=,rekernel=,bbg='
        required: false
        type: string
        default: 'lz4=y,lz4kd=n,better_net=y,bbr=n,ssg=y,rekernel=n,bbg=y'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: 运行 5.15.167 构建脚本
        id: build_kernel
        run: |
          chmod +x local/builder_5.15.167.sh
          cd "$GITHUB_WORKSPACE"

          if [ -n "${{ inputs.manifest }}" ]; then
            export MANIFEST='${{ inputs.manifest }}'
          fi
          if [ -n "${{ inputs.kernel_branch }}" ]; then
            export KERNEL_BRANCH='${{ inputs.kernel_branch }}'
          fi

          CUSTOM_SUFFIX='${{ inputs.custom_suffix }}'
          SUSFS_ANDROID='${{ inputs.susfs_android_version }}'
          USE_KPM='${{ inputs.enable_kpm }}'
          if [ '${{ inputs.ksu_type }}' = 'sukisu' ]; then
            KSU_BRANCH_INPUT='y'
          else
            KSU_BRANCH_INPUT='n'
          fi
          case '${{ inputs.hook_mode }}' in
            manual) HOOK_INPUT='m' ;;
            syscall) HOOK_INPUT='s' ;;
            kprobes) HOOK_INPUT='k' ;;
            *) HOOK_INPUT='m' ;;
          esac
          FEATURE_FLAGS_RAW='${{ inputs.feature_flags }}'
          FEATURE_FLAGS=$(printf '%s' "$FEATURE_FLAGS_RAW" | tr -d ' \t\n\r')
          get_flag() {
            local key="$1"
            local default="$2"
            local IFS=','
            for pair in $FEATURE_FLAGS; do
              if [ "${pair%%=*}" = "$key" ]; then
                local value="${pair#*=}"
                if [ -n "$value" ]; then
                  printf '%s' "$value"
                  return
                fi
              fi
            done
            printf '%s' "$default"
          }

          LZ4_INPUT=$(get_flag lz4 y)
          LZ4KD_INPUT=$(get_flag lz4kd n)
          BETTERNET_INPUT=$(get_flag better_net y)
          BBR_INPUT=$(get_flag bbr n)
          SSG_INPUT=$(get_flag ssg y)
          REKERNEL_INPUT=$(get_flag rekernel n)
          BBG_INPUT=$(get_flag bbg y)

          printf '%s\n%s\n%s\n%s\n%s\n%s\n%s\n%s\n%s\n%s\n%s\n%s\n' \
            "$CUSTOM_SUFFIX" \
            "$SUSFS_ANDROID" \
            "$USE_KPM" \
            "$KSU_BRANCH_INPUT" \
            "$HOOK_INPUT" \
            "$LZ4_INPUT" \
            "$LZ4KD_INPUT" \
            "$BETTERNET_INPUT" \
            "$BBR_INPUT" \
            "$SSG_INPUT" \
            "$REKERNEL_INPUT" \
            "$BBG_INPUT" \
            | local/builder_5.15.167.sh

      - name: 列出产物
        run: |
          ls -al kernel_workspace

      - name: 上传 AnyKernel3 ZIP
        uses: actions/upload-artifact@v4
        with:
          name: Kernel_5.15.167_Zips
          path: kernel_workspace/Anykernel3-*.zip
          if-no-files-found: error
